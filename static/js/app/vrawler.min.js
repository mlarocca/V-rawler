var Vrawler=function(){var u,g,s,w=0,q,t,v=[],k=[],x={x:16384,y:16384},y={x:32,y:32},z=/((http:[\/][\/])?(((www\.)?[a-z]|[A-Z]|[0-9]|[\/.]|[~])*)*)/i,A=/(https?:[\/][\/])/gi,m=Object.create({SERVER:"../",JSON_TAG:"json/",COLORS:"green red orange orangered yellow blue magenta salmon black turquoise darkgreen pink brown".split(" "),TEXT_COLORS:"yellow black indigo red black yellow red red white darkblue white red white".split(" "),init:function(){var a=$(window).innerWidth(),b=$(window).innerHeight()-
50;s=new Raphael("vrawler",a,b);this.setWidth(a);this.setHeight(b);s.canvas.setAttribute("class","svg-body");s.customAttributes.vertex_index=function(a){return{vertex_index:a}};return this},getWidth:function(){return u},setWidth:function(a){u=a;return this},getHeight:function(){return g},setHeight:function(a){g=a;return this},getServerUrl:function(){return this.SERVER+this.JSON_TAG},formatPagePath:function(a){return 0<a.length&&"/"===a.charAt(0)?"/"+a.substr(1).replace(/\//g,"\n/"):"/"+a.replace(/\//g,
"\n/")},clearAll:function(){var a,b,d,c,f,e;this.clearGEMTimeout();f=k.length;for(a=0;a<f;a++){d=k[a];d.glowTimeout&&clearTimeout(d.glowTimeout);d.vertex.unbindAll();d.label.unbindAll();delete d.vertex;delete d.label;c=d.edge_lines;e=c.length;for(b=0;b<e;b++)c[b].unbindAll(),delete c[b];delete d.edges;delete d.edge_lines;delete k[a]}k.length=0;s.clear();return this},startGEM:function(a,b,d){t=new Worker("js/app/gem.min.js");for(var c=this,f=a.length,e,l=[],r=0;r<f;r++)e=a[r],e={x:e.x,y:e.y,index:e.index,
size:e.size,edges:e.edges},l[r]=e;t.postMessage({graph:l,max_rounds:d||20,viewWidth:this.getWidth(),viewHeight:this.getHeight(),DISTURBANCE_RANGE:y,DESIRED_EDGE_LENGTH_SQUARED:x});t.onmessage=function(a){a.data.stop?(t.terminate(),t=null):v.push(a.data)};q=setTimeout(function(){q=setInterval(c.nextGEMUpdateFunction,1E3)},b)},clearGEMTimeout:function(){q&&(clearInterval(q),q=null);t&&(t.terminate(),t=null);return this},pauseGEM:function(){q&&clearInterval(q);return this},stopGEM:function(){this.clearGEMTimeout();
v&&(v.length=0);return this},resumeGEM:function(){q?q=setInterval(this.nextGEMUpdateFunction,1E3):m.showInfo("GEM isn't currently running or paused, can't be resumed");return this},nextGEMUpdateFunction:function(){var a,b;if(0<v.length){a=v[0];v.splice(0,1);b=a.length;for(var d=0;d<b;d++)k[d].x=a[d].x,k[d].y=a[d].y;m.updateGraph(k)}else null===t&&m.stopGEM()},setDesiredEdgeLength:function(a,b){a>Math.sqrt(2)*b?a=Math.sqrt(2)*b:b>Math.sqrt(2)*a&&(b=Math.sqrt(2)*a);x={x:a*a,y:b*b};this.setDisturbanceRange(a/
8,b/8);return this},setDisturbanceRange:function(a,b){y={x:a,y:b};return this},randomCoordinates:function(){return[Math.floor(Math.random()*u),Math.floor(Math.random()*g)]},createLine:function(a,b,d,c){return s.path(this.getLinePath(a,b,d,c))},redrawLinePath:function(a,b,d,c,f){a.attr("path",this.getLinePath(b,d,c,f));return this},getLinePath:function(a,b,d,c){return["M",a," ",b," L",d," ",c].join("")},generateMouseOverEventHandler:function(a){return function(b){b=a[this.attr("vertex_index")];q||
b.glowTimeout||b.vertex.attr({"fill-opacity":0.8})}},generateMouseOutEventHandler:function(a){return function(b){b=a[this.attr("vertex_index")];b.glowTimeout||b.vertex.attr({"fill-opacity":0.5})}},generateDragStartEventHandler:function(a){var b=this.showInfo;return function(){var d=a[this.attr("vertex_index")];d.dragged=!1;q?b("When GEM algorithm is running or paused, vertex dragging is disabled. Click on STOP first."):(this.ox=d.vertex.attr("cx"),this.oy=d.vertex.attr("cy"),this.glowx=this.ox,this.glowy=
this.oy,d.dragging=!0)}},generateDragMoveEventHandler:function(a){var b=this;return function(d,c){var f=a[this.attr("vertex_index")],e,l,r,p,g;f.dragged=!0;if(f.dragging)for(f.x=this.ox+d,f.y=this.oy+c,f.vertex.attr({cx:f.x,cy:f.y}),f.label.attr({x:f.x,y:f.y}),f.vertex_glow.translate(f.x-this.glowx,f.y-this.glowy),this.glowx=f.x,this.glowy=f.y,r=f.edges,g=r.length,p=0;p<g;p++)l=r[p],e=a[l],"undefined"!==typeof f.edge_lines[l]?(l=f.edge_lines[l],l.attr({path:b.getLinePath(f.x,f.y,e.x,e.y)})):(l=e.edge_lines[f.index],
l.attr({path:b.getLinePath(e.x,e.y,f.x,f.y)}))}},generateDragUpEventHandler:function(a){var b=this;return function(d){var c=a[this.attr("vertex_index")];c.dragging&&c.dragged&&2!==d.button&&b.startGEM(a,250,5);c.dragging=!1;d.preventDefault();d.stopPropagation();return!1}},generateClickEventHandler:function(a,b){var d=this;return function(c){var f=this.attr("vertex_index"),e=b[f];a[f].dragged||d.showPageDetails(e.url,e.links,e.resources.images,e.resources.videos,e.resources.audios);c.preventDefault();
c.stopPropagation()}},generateGlowCallback:function(a){return function(){a.vertex_glow=a.vertex.glow({width:30,color:a.vertex_color,fill:!0});a=a.glowTimeout=null}},disableContentMenuFunction:function(){return!1},drawGraph:function(a,b){var d,c,f,e,l,r,p,g=0,n,h,k,q=a.length,m=0;s.clear();n=s.set();for(k=0;k<q;k++)h=a[k],c=b[k],e=this.randomCoordinates(),h.x=h.x0=e[0],h.y=h.y0=e[1],c.page_size>g&&(g=c.page_size);for(k=0;k<q;k++){h=a[k];d=h.edges;p=d.length;c=b[k];h.edge_lines={};for(l=0;l<p;l++)f=
a[d[l]],f.index>k&&(e=250+750*Math.max(c.depth,b[d[l]].depth),m<e&&(m=e),r=Raphael.animation({"stroke-opacity":0.5},1E3,"easeIn"),e=this.createLine(h.x,h.y,f.x,f.y).attr("stroke","turquoise").attr("stroke-opacity",0).toBack().animate(r.delay(e)),h.edge_lines[f.index]=e);d=h.vertex_color=this.COLORS[c.depth];f=this.TEXT_COLORS[c.depth];l=Raphael.animation({"fill-opacity":0.5,stroke:d,"stroke-opacity":1},1E3,"easeIn");p=Raphael.animation({"fill-opacity":1},1E3,"easeIn");e=250+750*c.depth;h.radius=35+
55/(g||1)*(c.page_size||1);h.size=h.radius/90;h.radius=Math.round(h.radius);h.vertex=s.circle(h.x,h.y,h.radius).attr({fill:d,"fill-opacity":0,"stroke-opacity":0,stroke:"#111","stroke-width":3,vertex_index:k}).animate(l.delay(e));n.push(h.vertex);h.vertex.node.setAttribute("class","vertex");h.vertex.node.oncontextmenu=this.disableContentMenuFunction;h.label=s.text(h.x,h.y,this.formatPagePath(c.path)).attr({fill:f,"fill-opacity":0,"font-size":14,vertex_index:k}).animateWith(h.vertex,l,p.delay(e));n.push(h.label);
h.label.node.setAttribute("class","vertex-text");h.label.node.oncontextmenu=this.disableContentMenuFunction;h.glowTimeout=setTimeout(this.generateGlowCallback(h),e+500)}n.mouseover(this.generateMouseOverEventHandler(a));n.mouseout(this.generateMouseOutEventHandler(a));n.drag(this.generateDragMoveEventHandler(a),this.generateDragStartEventHandler(a),this.generateDragUpEventHandler(a));n.click(this.generateClickEventHandler(a,b));return m+1E3},updateGraph:function(a){var b,d,c,f,e,l,k,g=a.length;for(e=
0;e<g;e++)for(c=a[e],b=c.edges,k=c.edges.length,d=Raphael.animation({x:c.x,y:c.y},1E3,"easeIn"),c.label.animate(d),c.vertex.animateWith(c.label,d,{cx:c.x,cy:c.y},1E3,"easeIn"),c.vertex_glow&&c.vertex_glow.animateWith(c.label,d,{transform:"t"+(c.x-c.x0)+" "+(c.y-c.y0)},1E3,"easeIn"),l=0;l<k;l++)f=b[l],"undefined"!==typeof c.edge_lines[f]&&(d=a[f],f=c.edge_lines[f],f.animate({path:this.getLinePath(c.x,c.y,d.x,d.y)},1E3,"easeIn"))},showPageDetails:function(a,b,d,c,f){var e=function(a,b){var d,c,e,f;
a.empty();c=b.length;for(d=0;d<c;d++)e=$("<li></li>"),f=$("<a href='"+b[d]+"' target='blank'>"+b[d]+"</a>"),e.append(f),a.append(e)};$("#detailsModalTitle").text(a);$("#detailsModalTitle").attr("href",a);e($("#linksUl"),b);e($("#imagesUl"),d);e($("#videosUl"),c);e($("#audiosUl"),f);$("#detailsModal").modal({show:!0})},showLoading:function(a){if(a){a=m.getHeight()/2-parseInt($(".loading-img").css("height"),10)/2;var b=m.getWidth()/2-parseInt($(".loading-img").css("width"),10)/2;$("#loading").css({visibility:"visible",
"z-index":1,top:a,left:b})}else $("#loading").css({visibility:"hidden","z-index":-1})},scheduleMessageRemoval:function(a){setTimeout(function(){a.remove()},5E3)},showError:function(a){a=$('<div class="alert alert-danger vrawler-alert"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Warning!</strong> <span id="dangerMessage">'+a+"</span></div>");$("body").append(a);m.scheduleMessageRemoval(a)},showWarning:function(a){a=$('<div class="alert alert-info vrawler-alert"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Warning!</strong> <span id="dangerMessage">'+
a+"</span></div>");$("body").append(a);m.scheduleMessageRemoval(a)},showInfo:function(a){a=$('<div class="alert alert-success vrawler-alert"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Info:</strong> <span id="dangerMessage">'+a+"</span></div>");$("body").append(a);m.scheduleMessageRemoval(a)},showHelp:function(a){a?$("#help-frame-content").load("help/help-en.html",function(a,d,c){"error"===d?(console.log(c.status,c.statusText),m.showError("Sorry, we couldn't load the help file for your language.")):
$("#help-frame").css({visibility:"visible","z-index":1})}):$("#help-frame").css({visibility:"hidden","z-index":-1})},validateURL:function(a){a=a.trim();if(!1===z.test(a))return null;a=a.replace(A,"");return/:\/\/|(^mailto:$)/.test(a)?null:a},getSiteMap:function(a){$("#startModal").modal("hide");this.stopGEM();this.clearAll();var b=this;(a=this.validateURL(a))?0<w?this.showWarning("An url is currently being parsed. Please wait until the request is completed"):(this.showLoading(!0),++w,$.getJSON(a,
{format:"jsonp"}).done(function(a){var c={},f=[],e,l,g,p,m,n;k=[];for(m in a)p=a[m],p.url=m,n=f.length,c[m]=n,f.push(p),k[n]={index:n,x:0,y:0,edges:[]};e=k.length;if(0<e){b.setDesiredEdgeLength(b.getWidth()/Math.log(e+1),b.getHeight()/Math.log(e+1));for(m in a)for(n=c[m],e=k[n],p=a[m],l=0;l<p.links.length;l++)g=c[p.links[l]],"undefined"!==typeof g&&g!==n&&0>$.inArray(g,e.edges)&&(e.edges.push(g),0>$.inArray(n,k[g].edges)&&k[g].edges.push(n));b.showLoading(!1);a=b.drawGraph(k,f);b.startGEM(k,a)}else b.showLoading(!1),
b.showError("Impossible to crawl the URL inserted")}).always(function(){--w}),$(document).ajaxError(function(a,c){b.showLoading(!1);400===c.status?b.showError("Website not found, please check the URL"):408===c.status?b.showWarning("Too many requests from this IP address: please wait at least 10 seconds"):b.showError("Impossible to crawl the URL inserted")})):this.showError("Error: the URL inserted isn't valid")}});Object.freeze(m);return m}();
$(function(){Raphael.el.unbindAll=function(){for(;this.events.length;)this.events.pop().unbind()};$("#detailsTab a").click(function(u){u.preventDefault();$(this).tab("show")});$(window).load(function(){var u;Vrawler.init();$("#goSubmit").click(function(g){Vrawler.getSiteMap(Vrawler.getServerUrl()+$("#urlFieldNavBar").val())});$("#urlFieldNavBar").keypress(function(g){13===g.which&&(g.preventDefault(),Vrawler.getSiteMap(Vrawler.getServerUrl()+$("#urlFieldNavBar").val()))});$("#goButton").click(function(g){Vrawler.getSiteMap(Vrawler.getServerUrl()+
$("#urlField").val())});$("#urlField").keypress(function(g){13===g.which&&(g.preventDefault(),Vrawler.getSiteMap(Vrawler.getServerUrl()+$("#urlField").val()))});$("#helpButton").click(function(g){Vrawler.showHelp(!0)});$("#helpClose").click(function(g){Vrawler.showHelp()});$("#clearButton").click(function(g){Vrawler.clearAll()});$("#pauseButton").click(function(g){Vrawler.pauseGEM()});$("#stopButton").click(function(g){Vrawler.stopGEM()});$("#resumeButton").click(function(g){Vrawler.resumeGEM()});
$(".page-title").click(function(g){$("#startModal").modal({show:!0})});(u=$.url().param("url"))?Vrawler.getSiteMap(Vrawler.getServerUrl()+u):$("#startModal").modal({show:!0})})}());