var Vrawler=function(){var x,g,n,w,y=null,D=16384,E=16384,F=32,G=32,J=Math.PI/3,K=Math.PI,H,L=1/3,M=/((http:[\/][\/])?(((www\.)?[a-z]|[A-Z]|[0-9]|[\/.]|[~])*)*)/i,N=/(https?:[\/][\/])/gi,I=Object.create({SERVER:"../",JSON_TAG:"json/",COLORS:"green red orange orangered yellow blue magenta salmon black turquoise darkgreen pink brown".split(" "),TEXT_COLORS:"yellow black indigo red black yellow red red white darkblue white red white".split(" "),vertices:[],init:function(){var a=$(window).innerWidth(),
b=$(window).innerHeight()-50;n=new Raphael("vrawler",a,b);this.setWidth(a);this.setHeight(b);n.canvas.setAttribute("class","svg-body");n.customAttributes.vertex_index=function(a){return{vertex_index:a}};return this},getWidth:function(){return x},setWidth:function(a){x=a;return this},getHeight:function(){return g},setHeight:function(a){g=a;return this},getServerUrl:function(){return this.SERVER+this.JSON_TAG},formatPagePath:function(a){return 0<a.length&&"/"===a.charAt(0)?"/"+a.substr(1).replace(/\//g,
"\n/"):"/"+a.replace(/\//g,"\n/")},clearAll:function(){var a,b,f,c,d,e;this.clearGEMTimeout();y=null;d=this.vertices.length;for(a=0;a<d;a++){f=this.vertices[a];f.glowTimeout&&clearTimeout(f.glowTimeout);f.vertex.unbindAll();f.label.unbindAll();delete f.vertex;delete f.label;c=f.edge_lines;e=c.length;for(b=0;b<e;b++)c[b].unbindAll(),delete c[b];delete f.edges;delete f.edge_lines;delete this.vertices[a]}this.vertices.length=0;n.clear();return this},clearGEMTimeout:function(){w&&(clearTimeout(w),w=null);
return this},pauseGEM:function(){w&&clearTimeout(w);return this},stopGEM:function(){this.clearGEMTimeout();y=null;return this},resumeGEM:function(){w&&"function"===typeof y&&(w=setTimeout(y,1E3));return this},setDesiredEdgeLength:function(a,b){a>Math.sqrt(2)*b?a=Math.sqrt(2)*b:b>Math.sqrt(2)*a&&(b=Math.sqrt(2)*a);D=a*a;E=b*b;this.setDisturbanceRange(a/8,b/8);return this},setDisturbanceRange:function(a,b){F=a;G=b;return this},randomCoordinates:function(){return[Math.floor(Math.random()*x),Math.floor(Math.random()*
g)]},createLine:function(a,b,f,c){return n.path(this.getLinePath(a,b,f,c))},redrawLinePath:function(a,b,f,c,d){a.attr("path",this.getLinePath(b,f,c,d));return this},getLinePath:function(a,b,f,c){return["M",a," ",b," L",f," ",c].join("")},startGEM:function(a,b,f){var c=this;w=setTimeout(function(){c.GEM(a,f||20)},b)},GEM:function(a,b){var f,c,d=this,e=a.length,l,C=[],q=[],z=[],r=[],h=Array(e),u=function(){var v,k;if(0.001>=f||c>=b)d.stopGEM();else{c+=1;v=h;var m,s;for(m=1;m<e;m++)k=Math.floor(Math.random()*
m),s=v[m],v[m]=v[k],v[k]=s;h=v;for(v=0;v<e;v++){k=h[v];m=a[k];s=k;var g=l,p=a[s],A=(Math.random()-0.5)*F,B=(Math.random()-0.5)*G,n=void 0,t=void 0,x=p.edges.length;k={x:0,y:0};var y=t=void 0,t=0.0625*r[s]*p.size;k.x=(g.x-p.x)*t;k.y=(g.y-p.y)*t;if(p.x<=p.radius||p.x+p.radius>=d.getWidth())k.x*=4;if(p.y<=p.radius||p.y+p.radius>=d.getHeight())k.y*=4;k.x+=A;k.y+=B;for(n=0;n<e;n++)n!==s&&(t=a[n],A=p.x-t.x,B=p.y-t.y,0!==A||0!==B)&&(y=A*A+B*B,t=p.size*t.size/y,k.x+=A*D*t,k.y+=B*E*t);for(n=0;n<x;n++)t=a[p.edges[n]],
A=p.x-t.x,B=p.y-t.y,y=A*A+B*B,t=y/r[s],k.x-=A/D*t,k.y-=B/E*t;s=m;m=k;p=void 0;k=s.index;g=z[k];p=void 0;if(0!==m.x||0!==m.y)p=Math.sqrt(m.x*m.x+m.y*m.y),m.x*=C[k]/p,m.y*=C[k]/p,s.x+=m.x,s.y+=m.y,l.x+=m.x/e,l.y+=m.y/e;if(0!==g.x||0!==g.y)p=Math.acos((m.x*g.x+m.y*g.y)/Math.sqrt(m.x*m.x+m.y*m.y)/Math.sqrt(g.x*g.x+g.y*g.y)),s=Math.sin(p),g=Math.cos(p),s>Math.sin(Math.PI+J/2)&&(q[k]+=H*s?0>s?-1:1:0),Math.abs(g)>Math.cos(K/2)&&(C[k]*=L*g),C[k]*=1-q[k],C[k]=Math.min(C[k],256),z[k]=m}d.updateGraph(a);w=setTimeout(u,
1E3)}};y=u;(function(){var b,d;c=0;f=50;H=0.5/e;l={x:0,y:0};for(b=0;b<e;b++)d=a[b],l.x+=d.x,l.y+=d.y,C[b]=50,q[b]=0,z[b]={x:0,y:0},r[b]=1+d.edges.length/2,h[b]=b;l.x/=e;l.y/=e})();u()},generateMouseOverEventHandler:function(a){return function(b){b=a[this.attr("vertex_index")];w||b.glowTimeout||b.vertex.attr({"fill-opacity":0.8})}},generateMouseOutEventHandler:function(a){return function(b){b=a[this.attr("vertex_index")];b.glowTimeout||b.vertex.attr({"fill-opacity":0.5})}},generateDragStartEventHandler:function(a){return function(){var b=
a[this.attr("vertex_index")];b.dragged=!1;w||(this.ox=b.vertex.attr("cx"),this.oy=b.vertex.attr("cy"),this.glowx=this.ox,this.glowy=this.oy,b.dragging=!0)}},generateDragMoveEventHandler:function(a){var b=this;return function(f,c){var d=a[this.attr("vertex_index")],e,l,g,q,z;d.dragged=!0;if(d.dragging)for(d.x=this.ox+f,d.y=this.oy+c,d.vertex.attr({cx:d.x,cy:d.y}),d.label.attr({x:d.x,y:d.y}),d.vertex_glow.translate(d.x-this.glowx,d.y-this.glowy),this.glowx=d.x,this.glowy=d.y,g=d.edges,z=g.length,q=
0;q<z;q++)l=g[q],e=a[l],"undefined"!==typeof d.edge_lines[l]?(l=d.edge_lines[l],l.attr({path:b.getLinePath(d.x,d.y,e.x,e.y)})):(l=e.edge_lines[d.index],l.attr({path:b.getLinePath(e.x,e.y,d.x,d.y)}))}},generateDragUpEventHandler:function(a){var b=this;return function(f){var c=a[this.attr("vertex_index")];c.dragging&&(c.dragged&&2!==f.button)&&b.startGEM(a,250,5);c.dragging=!1;f.preventDefault();f.stopPropagation();return!1}},generateClickEventHandler:function(a,b){var f=this;return function(c){var d=
this.attr("vertex_index"),e=b[d];a[d].dragged||f.showPageDetails(e.url,e.links,e.resources.images,e.resources.videos,e.resources.audios);c.preventDefault();c.stopPropagation()}},generateGlowCallback:function(a){return function(){a.vertex_glow=a.vertex.glow({width:30,color:a.vertex_color,fill:!0});a=a.glowTimeout=null}},disableContentMenuFunction:function(){return!1},drawGraph:function(a,b){var f,c,d,e,l,g,q,z=0,r,h,u,v=a.length,k=0;n.clear();r=n.set();for(u=0;u<v;u++)h=a[u],c=b[u],e=this.randomCoordinates(),
h.x=h.x0=e[0],h.y=h.y0=e[1],c.page_size>z&&(z=c.page_size);for(u=0;u<v;u++){h=a[u];f=h.edges;q=f.length;c=b[u];h.edge_lines={};for(l=0;l<q;l++)d=a[f[l]],d.index>u&&(e=250+750*Math.max(c.depth,b[f[l]].depth),k<e&&(k=e),g=Raphael.animation({"stroke-opacity":0.5},1E3,"easeIn"),e=this.createLine(h.x,h.y,d.x,d.y).attr("stroke","turquoise").attr("stroke-opacity",0).toBack().animate(g.delay(e)),h.edge_lines[d.index]=e);f=h.vertex_color=this.COLORS[c.depth];d=this.TEXT_COLORS[c.depth];l=Raphael.animation({"fill-opacity":0.5,
stroke:f,"stroke-opacity":1},1E3,"easeIn");q=Raphael.animation({"fill-opacity":1},1E3,"easeIn");e=250+750*c.depth;h.radius=35+55/(z||1)*(c.page_size||1);h.size=h.radius/90;h.radius=Math.round(h.radius);h.vertex=n.circle(h.x,h.y,h.radius).attr({fill:f,"fill-opacity":0,"stroke-opacity":0,stroke:"#111","stroke-width":3,vertex_index:u}).animate(l.delay(e));r.push(h.vertex);h.vertex.node.setAttribute("class","vertex");h.vertex.node.oncontextmenu=this.disableContentMenuFunction;h.label=n.text(h.x,h.y,this.formatPagePath(c.path)).attr({fill:d,
"fill-opacity":0,"font-size":14,vertex_index:u}).animateWith(h.vertex,l,q.delay(e));r.push(h.label);h.label.node.setAttribute("class","vertex-text");h.label.node.oncontextmenu=this.disableContentMenuFunction;h.glowTimeout=setTimeout(this.generateGlowCallback(h),e+500)}r.mouseover(this.generateMouseOverEventHandler(a));r.mouseout(this.generateMouseOutEventHandler(a));r.drag(this.generateDragMoveEventHandler(a),this.generateDragStartEventHandler(a),this.generateDragUpEventHandler(a));r.click(this.generateClickEventHandler(a,
b));return k+1E3},updateGraph:function(a){var b,f,c,d,e,l,g,q=a.length;for(e=0;e<q;e++)for(c=a[e],b=c.edges,g=c.edges.length,f=Raphael.animation({x:c.x,y:c.y},1E3,"easeIn"),c.label.animate(f),c.vertex.animateWith(c.label,f,{cx:c.x,cy:c.y},1E3,"easeIn"),c.vertex_glow&&c.vertex_glow.animateWith(c.label,f,{transform:"t"+(c.x-c.x0)+" "+(c.y-c.y0)},1E3,"easeIn"),l=0;l<g;l++)d=b[l],"undefined"!==typeof c.edge_lines[d]&&(f=a[d],d=c.edge_lines[d],d.animate({path:this.getLinePath(c.x,c.y,f.x,f.y)},1E3,"easeIn"))},
showPageDetails:function(a,b,f,c,d){var e=function(a,b){var c,d,e,f;a.empty();d=b.length;for(c=0;c<d;c++)e=$("<li></li>"),f=$("<a href='"+b[c]+"' target='blank'>"+b[c]+"</a>"),e.append(f),a.append(e)};$("#detailsModalTitle").text(a);$("#detailsModalTitle").attr("href",a);e($("#linksUl"),b);e($("#imagesUl"),f);e($("#videosUl"),c);e($("#audiosUl"),d);$("#detailsModal").modal({show:!0})},showLoading:function(a){a?$("#loadingFrame").css({visibility:"visible","z-index":1}):$("#loadingFrame").css({visibility:"hidden",
"z-index":-1})},showError:function(a){a=$('<div class="alert alert-danger vrawler-alert"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Warning!</strong> <span id="dangerMessage">'+a+"</span></div>");$("body").append(a)},showWarning:function(a){a=$('<div class="alert alert-info vrawler-alert"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Warning!</strong> <span id="dangerMessage">'+a+"</span></div>");$("body").append(a)},validateURL:function(a){a=
a.trim();if(!1===M.test(a))return null;a=a.replace(N,"");return/:\/\/|(^mailto:$)/.test(a)?null:a},getSiteMap:function(a){$("#startModal").modal("hide");this.clearAll();var b=this;(a=this.validateURL(a))?(this.showLoading(!0),$.getJSON(a,{format:"jsonp"}).done(function(a){var c={},d=[],e,l,g,q,n,r,h=[];for(n in a)q=a[n],q.url=n,r=d.length,c[n]=r,d.push(q),h[r]={index:r,x:0,y:0,edges:[]},b.vertices.push(h[r]);e=h.length;if(0<e){b.setDesiredEdgeLength(b.getWidth()/Math.log(e+1),b.getHeight()/Math.log(e+
1));for(n in a)for(r=c[n],e=h[r],q=a[n],l=0;l<q.links.length;l++)g=c[q.links[l]],"undefined"!==typeof g&&(g!==r&&0>$.inArray(g,e.edges))&&(e.edges.push(g),0>$.inArray(r,h[g].edges)&&h[g].edges.push(r));b.showLoading(!1);a=b.drawGraph(h,d);b.startGEM(h,a)}else b.showLoading(!1),b.showError("Impossible to crawl the URL inserted")}),$(document).ajaxError(function(a,c){b.showLoading(!1);400===c.status?b.showError("Website not found, please check the URL"):408===c.status?b.showWarning("Too many requests from this IP address: please wait at least 10 seconds"):
b.showError("Impossible to crawl the URL inserted")})):this.showError("Error: the URL inserted isn't valid")}});Object.freeze(I);return I}();
$(function(){Raphael.el.unbindAll=function(){for(;this.events.length;)this.events.pop().unbind()};$("#detailsTab a").click(function(x){x.preventDefault();$(this).tab("show")});$(window).load(function(){var x;Vrawler.init();$("#goSubmit").click(function(g){Vrawler.getSiteMap(Vrawler.getServerUrl()+$("#urlFieldNavBar").val())});$("#urlFieldNavBar").keypress(function(g){13===g.which&&(g.preventDefault(),Vrawler.getSiteMap(Vrawler.getServerUrl()+$("#urlFieldNavBar").val()))});$("#goButton").click(function(g){Vrawler.getSiteMap(Vrawler.getServerUrl()+
$("#urlField").val())});$("#urlField").keypress(function(g){13===g.which&&(g.preventDefault(),Vrawler.getSiteMap(Vrawler.getServerUrl()+$("#urlField").val()))});$("#clearButton").click(function(g){Vrawler.clearAll()});$("#pauseButton").click(function(g){Vrawler.pauseGEM()});$("#stopButton").click(function(g){Vrawler.clearGEMTimeout()});$("#resumeButton").click(function(g){Vrawler.resumeGEM()});$(".page-title").click(function(g){$("#startModal").modal({show:!0})});(x=$.url().param("url"))?Vrawler.getSiteMap(Vrawler.getServerUrl()+
x):$("#startModal").modal({show:!0})})}());